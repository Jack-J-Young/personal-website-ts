import{NotFoundError as e,ValidationError as t,ERROR_CODE as a}from"./error";import{mapEarlyResponse as r,mapResponse as s}from"./handler";import{parse as n}from"fast-querystring";export const createDynamicHandler=o=>async a=>{let i;let l={status:200,headers:{}};o.decorators?((i=o.decorators).request=a,i.set=l,i.store=o.store):i={set:l,store:o.store,request:a};let f=a.url,c=f.indexOf("/",11),d=f.indexOf("?",c+1),w=-1===d?f.substring(c):f.substring(c,d);try{let c;for(let e=0;e<o.event.request.length;e++){let t=o.event.request[e],a=t(i);if(a instanceof Promise&&(a=await a),a=r(a,l))return a}let m=o.dynamicRouter.find(a.method,w)??o.dynamicRouter.find("ALL",w);if(!m)throw new e;let{handle:u,hooks:h,validator:p,content:y}=m.store;if("GET"!==a.method){if(y)switch(y){case"application/json":c=await a.json();break;case"text/plain":c=await a.text();break;case"application/x-www-form-urlencoded":c=n(await a.text());break;case"application/octet-stream":c=await a.arrayBuffer();break;case"multipart/form-data":c={};let e=await a.formData();for(let t of e.keys()){if(c[t])continue;let a=e.getAll(t);1===a.length?c[t]=a[0]:c[t]=a}}else{let e=a.headers.get("content-type");if(e){let t=e.indexOf(";");-1!==t&&(e=e.slice(0,t));for(let t=0;t<o.event.parse.length;t++){let a=o.event.parse[t](i,e);if(a instanceof Promise&&(a=await a),a){c=a;break}}if(void 0===c)switch(e){case"application/json":c=await a.json();break;case"text/plain":c=await a.text();break;case"application/x-www-form-urlencoded":c=n(await a.text());break;case"application/octet-stream":c=await a.arrayBuffer();break;case"multipart/form-data":c={};let r=await a.formData();for(let e of r.keys()){if(c[e])continue;let t=r.getAll(e);1===t.length?c[e]=t[0]:c[e]=t}}}}}i.body=c,i.params=m?.params||{},i.query=-1===d?{}:n(f.substring(d+1));for(let e=0;e<h.transform.length;e++){let t=h.transform[e](i);"derive"===h.transform[e].$elysia?t instanceof Promise?Object.assign(i,await t):Object.assign(i,t):t instanceof Promise&&await t}if(p){if(p.headers){let e={};for(let t in a.headers)e[t]=a.headers.get(t);if(!1===p.headers.Check(e))throw new t("header",p.headers,e)}if(p.params?.Check(i.params)===!1)throw new t("params",p.params,i.params);if(p.query?.Check(i.query)===!1)throw new t("query",p.query,i.query);if(p.body?.Check(c)===!1)throw new t("body",p.body,c)}for(let e=0;e<h.beforeHandle.length;e++){let t=h.beforeHandle[e](i);if(t instanceof Promise&&(t=await t),void 0!==t){for(let e=0;e<h.afterHandle.length;e++){let a=h.afterHandle[e](i,t);a instanceof Promise&&(a=await a),a&&(t=a)}let e=r(t,i.set);if(e)return e}}let g=u(i);if(g instanceof Promise&&(g=await g),h.afterHandle.length)for(let e=0;e<h.afterHandle.length;e++){let a=h.afterHandle[e](i,g);a instanceof Promise&&(a=await a);let s=r(a,i.set);if(void 0!==s){let e=p?.response?.[g.status];if(e?.Check(s)===!1)throw new t("response",e,s);return s}}else{let e=p?.response?.[g.status];if(e?.Check(g)===!1)throw new t("response",e,g)}return s(g,i.set)}catch(e){return e.status&&(l.status=e.status),o.handleError(a,e,l)}finally{for(let e of o.event.onResponse)await e(i)}};export const createDynamicErrorHandler=o=>async(e,t,r={headers:{}})=>{for(let n=0;n<o.event.error.length;n++){let i=o.event.error[n]({request:e,code:t.code??t[a]??"UNKNOWN",error:t,set:r});if(i instanceof Promise&&(i=await i),null!=i)return s(i,r)}return new Response("string"==typeof t.cause?t.cause:t.message,{headers:r.headers,status:t.status??500})};