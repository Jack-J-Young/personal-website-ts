import{Memoirist as e}from"memoirist";import{ValidationError as r}from"../error";let s=s=>{let t=s.indexOf("/",10),i=s.indexOf("?",t);return -1===i?s.slice(t):s.slice(t,i)};export class ElysiaWS{raw;data;isSubscribed;constructor(s){this.raw=s,this.data=s.data,this.isSubscribed=s.isSubscribed}publish(s,t,i){return"object"==typeof t&&(t=JSON.stringify(t)),this.raw.publish(s,t,i),this}publishToSelf(s,t,i){return"object"==typeof t&&(t=JSON.stringify(t)),this.raw.publish(s,t,i),this}send(s){return"object"==typeof s&&(s=JSON.stringify(s)),this.raw.send(s),this}subscribe(s){return this.raw.subscribe(s),this}unsubscribe(s){return this.raw.unsubscribe(s),this}cork(s){return this.raw.cork(s),this}close(){return this.raw.close(),this}}export const ws=t=>i=>{i.wsRouter||(i.wsRouter=new e);let a=i.wsRouter;return i.config.serve||(i.config.serve={websocket:{...t,open(e){if(!e.data)return;let r=s(e?.data.request.url);if(!r)return;let t=a.find("subscribe",r)?.store;t&&t.open&&t.open(new ElysiaWS(e))},message(e,t){if(!e.data)return;let i=s(e?.data.request.url);if(!i)return;let n=a.find("subscribe",i)?.store;if(!n?.message)return;t=t.toString();let u=t.charCodeAt(0);if(47===u||123===u)try{t=JSON.parse(t)}catch(e){}else Number.isNaN(+t)||(t=+t);for(let r=0;r<e.data.transformMessage.length;r++){let s=e.data.transformMessage[r](t);void 0!==s&&(t=s)}if(e.data.message?.Check(t)===!1)return void e.send(new r("message",e.data.message,t).cause);n.message(new ElysiaWS(e),t)},close(e,r,t){if(!e.data)return;let i=s(e?.data.request.url);if(!i)return;let n=a.find("subscribe",i)?.store;n&&n.close&&n.close(new ElysiaWS(e),r,t)},drain(e){if(!e.data)return;let r=s(e?.data.request.url);if(!r)return;let t=a.find("subscribe",r)?.store;t&&t.drain&&t.drain(new ElysiaWS(e))}}}),i.decorate("publish",i.server?.publish).onStart(e=>{e.decorators.publish=e.server?.publish})};